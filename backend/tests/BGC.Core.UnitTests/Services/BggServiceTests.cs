using BGC.Core.Services;
using BGC.Tests.Core.Helpers;

namespace BGC.Core.UnitTests.Services
{
    public class BggServiceTests
    {
        private const string MockBoardGameDetails = @"<items termsofuse=""https://boardgamegeek.com/xmlapi/termsofuse""><item type=""boardgame"" id=""169786""><thumbnail>https://cf.geekdo-images.com/7k_nOxpO9OGIjhLq2BUZdA__thumb/img/eQ69OEDdjYjfKg6q5Navee87skU=/fit-in/200x150/filters:strip_icc()/pic3163924.jpg</thumbnail><image>https://cf.geekdo-images.com/7k_nOxpO9OGIjhLq2BUZdA__original/img/HlDb9F365w0tSP8uD1vf1pfniQE=/0x0/filters:format(jpeg)/pic3163924.jpg</image><name type=""primary"" sortindex=""1"" value=""Scythe""/><name type=""alternate"" sortindex=""1"" value=""Sçythe""/><name type=""alternate"" sortindex=""1"" value=""Коса""/><name type=""alternate"" sortindex=""1"" value=""Серп""/><name type=""alternate"" sortindex=""1"" value=""大鎌戦役""/><name type=""alternate"" sortindex=""1"" value=""鐮刀戰爭""/><name type=""alternate"" sortindex=""1"" value=""사이드""/><name type=""alternate"" sortindex=""1"" value=""사이쓰""/><description>It is a time of unrest in 1920s Europa. The ashes from the first great war still darken the snow. The capitalistic city-state known simply as ldquo;The Factoryrdquo;, which fueled the war with heavily armored mechs, has closed its doors, drawing the attention of several nearby countries.#10;#10;Scythe is an engine-building game set in an alternate-history 1920s period. It is a time of farming and war, broken hearts and rusted gears, innovation and valor. In Scythe, each player represents a character from one of five factions of Eastern Europe who are attempting to earn their fortune and claim their faction's stake in the land around the mysterious Factory. Players conquer territory, enlist new recruits, reap resources, gain villagers, build structures, and activate monstrous mechs.#10;#10;Each player begins the game with different resources (power, coins, combat acumen, and popularity), a different starting location, and a hidden goal. Starting positions are specially calibrated to contribute to each factionrsquo;s uniqueness and the asymmetrical nature of the game (each faction always starts in the same place).#10;#10;Scythe gives players almost complete control over their fate. Other than each playerrsquo;s individual hidden objective card, the only elements of luck or variability are ldquo;encounterrdquo; cards that players will draw as they interact with the citizens of newly explored lands. Each encounter card provides the player with several options, allowing them to mitigate the luck of the draw through their selection. Combat is also driven by choices, not luck or randomness.#10;#10;Scythe uses a streamlined action-selection mechanism (no rounds or phases) to keep gameplay moving at a brisk pace and reduce downtime between turns. While there is plenty of direct conflict for players who seek it, there is no player elimination.#10;#10;Every part of Scythe has an aspect of engine-building to it. Players can upgrade actions to become more efficient, build structures that improve their position on the map, enlist new recruits to enhance character abilities, activate mechs to deter opponents from invading, and expand their borders to reap greater types and quantities of resources. These engine-building aspects create a sense of momentum and progress throughout the game. The order in which players improve their engine adds to the unique feel of each game, even when playing one faction multiple times.#10;#10;</description><yearpublished value=""2016""/><minplayers value=""1""/><maxplayers value=""5""/><poll name=""suggested_numplayers"" title=""User Suggested Number of Players"" totalvotes=""1393""><results numplayers=""1""><result value=""Best"" numvotes=""58""/><result value=""Recommended"" numvotes=""520""/><result value=""Not Recommended"" numvotes=""327""/></results><results numplayers=""2""><result value=""Best"" numvotes=""52""/><result value=""Recommended"" numvotes=""669""/><result value=""Not Recommended"" numvotes=""373""/></results><results numplayers=""3""><result value=""Best"" numvotes=""315""/><result value=""Recommended"" numvotes=""719""/><result value=""Not Recommended"" numvotes=""88""/></results><results numplayers=""4""><result value=""Best"" numvotes=""860""/><result value=""Recommended"" numvotes=""303""/><result value=""Not Recommended"" numvotes=""21""/></results><results numplayers=""5""><result value=""Best"" numvotes=""369""/><result value=""Recommended"" numvotes=""551""/><result value=""Not Recommended"" numvotes=""121""/></results><results numplayers=""5+""><result value=""Best"" numvotes=""47""/><result value=""Recommended"" numvotes=""234""/><result value=""Not Recommended"" numvotes=""465""/></results></poll><playingtime value=""115""/><minplaytime value=""90""/><maxplaytime value=""115""/><minage value=""14""/><poll name=""suggested_playerage"" title=""User Suggested Player Age"" totalvotes=""297""><results><result value=""2"" numvotes=""2""/><result value=""3"" numvotes=""0""/><result value=""4"" numvotes=""0""/><result value=""5"" numvotes=""0""/><result value=""6"" numvotes=""4""/><result value=""8"" numvotes=""15""/><result value=""10"" numvotes=""49""/><result value=""12"" numvotes=""98""/><result value=""14"" numvotes=""109""/><result value=""16"" numvotes=""18""/><result value=""18"" numvotes=""2""/><result value=""21 and up"" numvotes=""0""/></results></poll><poll name=""language_dependence"" title=""Language Dependence"" totalvotes=""68""><results><result level=""21"" value=""No necessary in-game text"" numvotes=""1""/><result level=""22"" value=""Some necessary text - easily memorized or small crib sheet"" numvotes=""14""/><result level=""23"" value=""Moderate in-game text - needs crib sheet or paste ups"" numvotes=""50""/><result level=""24"" value=""Extensive use of text - massive conversion needed to be playable"" numvotes=""3""/><result level=""25"" value=""Unplayable in another language"" numvotes=""0""/></results></poll><link type=""boardgamecategory"" id=""1021"" value=""Economic""/><link type=""boardgamecategory"" id=""1046"" value=""Fighting""/><link type=""boardgamecategory"" id=""1016"" value=""Science Fiction""/><link type=""boardgamecategory"" id=""1086"" value=""Territory Building""/><link type=""boardgamemechanic"" id=""2080"" value=""Area Majority / Influence""/><link type=""boardgamemechanic"" id=""2857"" value=""Card Play Conflict Resolution""/><link type=""boardgamemechanic"" id=""2912"" value=""Contracts""/><link type=""boardgamemechanic"" id=""2875"" value=""End Game Bonuses""/><link type=""boardgamemechanic"" id=""2864"" value=""Force Commitment""/><link type=""boardgamemechanic"" id=""2676"" value=""Grid Movement""/><link type=""boardgamemechanic"" id=""2026"" value=""Hexagon Grid""/><link type=""boardgamemechanic"" id=""2886"" value=""King of the Hill""/><link type=""boardgamemechanic"" id=""2947"" value=""Movement Points""/><link type=""boardgamemechanic"" id=""2819"" value=""Solo / Solitaire Game""/><link type=""boardgamemechanic"" id=""2686"" value=""Take That""/><link type=""boardgamemechanic"" id=""2849"" value=""Tech Trees / Tech Tracks""/><link type=""boardgamemechanic"" id=""2015"" value=""Variable Player Powers""/><link type=""boardgamemechanic"" id=""2897"" value=""Variable Set-up""/><link type=""boardgamemechanic"" id=""2874"" value=""Victory Points as a Resource""/><link type=""boardgamemechanic"" id=""2974"" value=""Zone of Control""/><link type=""boardgamefamily"" id=""77906"" value=""Category: Dized Tutorial""/><link type=""boardgamefamily"" id=""66553"" value=""Components: Control Boards""/><link type=""boardgamefamily"" id=""64960"" value=""Components: Map (Continental / National scale)""/><link type=""boardgamefamily"" id=""63523"" value=""Components: Meeples (Black)""/><link type=""boardgamefamily"" id=""63519"" value=""Components: Meeples (Blue)""/><link type=""boardgamefamily"" id=""63520"" value=""Components: Meeples (Red)""/><link type=""boardgamefamily"" id=""63521"" value=""Components: Meeples (Yellow)""/><link type=""boardgamefamily"" id=""25158"" value=""Components: Miniatures""/><link type=""boardgamefamily"" id=""68769"" value=""Components: Wooden pieces  boards""/><link type=""boardgamefamily"" id=""50153"" value=""Continents: Europe""/><link type=""boardgamefamily"" id=""8374"" value=""Crowdfunding: Kickstarter""/><link type=""boardgamefamily"" id=""77349"" value=""Digital Implementations: Steam""/><link type=""boardgamefamily"" id=""73596"" value=""Digital Implementations: TableTop Simulator Mod (TTS)""/><link type=""boardgamefamily"" id=""70948"" value=""Digital Implementations: Tabletopia""/><link type=""boardgamefamily"" id=""38432"" value=""Game: Scythe""/><link type=""boardgamefamily"" id=""27646"" value=""Mechanism: Tableau Building""/><link type=""boardgamefamily"" id=""78680"" value=""Misc: Made by Panda""/><link type=""boardgamefamily"" id=""78198"" value=""Misc: Watch It Played How To Videos""/><link type=""boardgamefamily"" id=""72487"" value=""Organizations: Automa Factory""/><link type=""boardgamefamily"" id=""5666"" value=""Players: Games with Solitaire Rules""/><link type=""boardgamefamily"" id=""26464"" value=""Theme: Alternate History""/><link type=""boardgamefamily"" id=""37870"" value=""Theme: Dieselpunk""/><link type=""boardgamefamily"" id=""63004"" value=""Theme: Mech Warfare""/><link type=""boardgameexpansion"" id=""276229"" value=""Scythe: Bonus Promo Pack – 6 Promo Encounter Cards numbers 37-42""/><link type=""boardgameexpansion"" id=""262151"" value=""Scythe: Encounters""/><link type=""boardgameexpansion"" id=""199727"" value=""Scythe: Invaders from Afar""/><link type=""boardgameexpansion"" id=""279304"" value=""Scythe: Modular Board""/><link type=""boardgameexpansion"" id=""211731"" value=""Scythe: Promo Pack #1 – Encounter Cards 29-32""/><link type=""boardgameexpansion"" id=""221033"" value=""Scythe: Promo Pack #11 – Encounter Card 39""/><link type=""boardgameexpansion"" id=""232176"" value=""Scythe: Promo Pack #12 – Encounter Card 40""/><link type=""boardgameexpansion"" id=""232087"" value=""Scythe: Promo Pack #13 – Encounter Card 41""/><link type=""boardgameexpansion"" id=""237663"" value=""Scythe: Promo Pack #14 – Encounter Card 42""/><link type=""boardgameexpansion"" id=""205121"" value=""Scythe: Promo Pack #2 – Encounter Cards 33-36""/><link type=""boardgameexpansion"" id=""211732"" value=""Scythe: Promo Pack #3 – Objective Cards 24-27""/><link type=""boardgameexpansion"" id=""211733"" value=""Scythe: Promo Pack #4 – Factory Cards 13-18""/><link type=""boardgameexpansion"" id=""212879"" value=""Scythe: Promo Pack #6 – Encounter Card 37""/><link type=""boardgameexpansion"" id=""204984"" value=""Scythe: Promo Pack #7 – Encounter Card 38""/><link type=""boardgameexpansion"" id=""242277"" value=""Scythe: The Rise of Fenris""/><link type=""boardgameexpansion"" id=""223555"" value=""Scythe: The Wind Gambit""/><link type=""boardgameaccessory"" id=""334656"" value=""Scythe: Legendary Box – reDrewno Insert""/><link type=""boardgameaccessory"" id=""334654"" value=""Scythe: reDrewno Insert""/><link type=""boardgameaccessory"" id=""394548"" value=""Expeditions/Scythe: Red $5 Metal Coins""/><link type=""boardgameaccessory"" id=""394547"" value=""Scythe  Expeditions Metal Coins""/><link type=""boardgameaccessory"" id=""206690"" value=""Scythe: Action Tokens""/><link type=""boardgameaccessory"" id=""223406"" value=""Scythe: Automa Deck""/><link type=""boardgameaccessory"" id=""333426"" value=""Scythe: BGExpansions Faction Token Set""/><link type=""boardgameaccessory"" id=""207791"" value=""Scythe: Board Extension""/><link type=""boardgameaccessory"" id=""263803"" value=""Scythe: Broken Token Organizer""/><link type=""boardgameaccessory"" id=""317056"" value=""Scythe: Complete Rulebook""/><link type=""boardgameaccessory"" id=""297611"" value=""Scythe: Custom Enlistment Tokens""/><link type=""boardgameaccessory"" id=""309473"" value=""Scythe: e-Raptor Insert""/><link type=""boardgameaccessory"" id=""242715"" value=""Scythe: Encounter and Expansion Tokens""/><link type=""boardgameaccessory"" id=""226917"" value=""Scythe: Encounter Campfire Tokens""/><link type=""boardgameaccessory"" id=""361379"" value=""Scythe: Encounter Token Promo Coin""/><link type=""boardgameaccessory"" id=""207629"" value=""Scythe: Encounter Tokens""/><link type=""boardgameaccessory"" id=""232123"" value=""Scythe: Faction Boxes""/><link type=""boardgameaccessory"" id=""267461"" value=""Scythe: Folded Space Insert""/><link type=""boardgameaccessory"" id=""282766"" value=""Scythe: GeekUp Bag Set""/><link type=""boardgameaccessory"" id=""216398"" value=""Scythe: Invaders from Afar – Promo Pack #8: Power dials""/><link type=""boardgameaccessory"" id=""242714"" value=""Scythe: Large Action Tokens""/><link type=""boardgameaccessory"" id=""334019"" value=""Scythe: Laserox Scythe Silo Organizer""/><link type=""boardgameaccessory"" id=""335250"" value=""Scythe: lbStudiosOnEtsy Faction Buildings Custom Meeples""/><link type=""boardgameaccessory"" id=""235883"" value=""Scythe: Legendary Box""/><link type=""boardgameaccessory"" id=""389996"" value=""Scythe: Legendary Box – Kalkared Insert""/><link type=""boardgameaccessory"" id=""320029"" value=""Scythe: Legendary Box – Tower Rex Organizer""/><link type=""boardgameaccessory"" id=""279496"" value=""Scythe: Legendary Box – WarBox Organizer""/><link type=""boardgameaccessory"" id=""268239"" value=""Scythe: Legendary Organizer – Broken Token Insert""/><link type=""boardgameaccessory"" id=""211947"" value=""Scythe: Metal Coins""/><link type=""boardgameaccessory"" id=""263346"" value=""Scythe: Metal Mechs""/><link type=""boardgameaccessory"" id=""266152"" value=""Scythe: Neoprene Playmat""/><link type=""boardgameaccessory"" id=""216392"" value=""Scythe: Promo Pack #10 – $2 Albion Metal Coins""/><link type=""boardgameaccessory"" id=""231641"" value=""Scythe: Promo Pack #15 – $10 Nordic Metal Coins""/><link type=""boardgameaccessory"" id=""257269"" value=""Scythe: Promo Pack #16 – $1 Metal Coins""/><link type=""boardgameaccessory"" id=""257270"" value=""Scythe: Promo Pack #17 – $5 Rusviet Metal Coins""/><link type=""boardgameaccessory"" id=""214599"" value=""Scythe: Promo Pack #5 – Original Faction Power Dials""/><link type=""boardgameaccessory"" id=""216391"" value=""Scythe: Promo Pack #9 – $50 Metal Coins""/><link type=""boardgameaccessory"" id=""238417"" value=""Scythe: Realistic Resource Tokens""/><link type=""boardgameaccessory"" id=""330823"" value=""Scythe: ScytheKick""/><link type=""boardgameaccessory"" id=""264324"" value=""Scythe: Silicon Base Snaps""/><link type=""boardgameaccessory"" id=""378775"" value=""Scythe: Spielmaterial.de Updgrade""/><link type=""boardgameaccessory"" id=""268417"" value=""Scythe: The Game Doctors Insert""/><link type=""boardgameaccessory"" id=""348650"" value=""Scythe: The GiftForge Insert""/><link type=""boardgameaccessory"" id=""260687"" value=""Scythe: The Rise of Fenris – Spoiler-Free Upgrade Kit""/><link type=""boardgameaccessory"" id=""267172"" value=""Scythe: Tower Rex Organizer""/><link type=""boardgameaccessory"" id=""243232"" value=""Scythe: Upgraded Worker Meeples""/><link type=""boardgameimplementation"" id=""226320"" value=""My Little Scythe""/><link type=""boardgamedesigner"" id=""62640"" value=""Jamey Stegmaier""/><link type=""boardgameartist"" id=""33148"" value=""Jakub Rozalski""/><link type=""boardgamepublisher"" id=""23202"" value=""Stonemaier Games""/><link type=""boardgamepublisher"" id=""4304"" value=""Albi""/><link type=""boardgamepublisher"" id=""38809"" value=""Angry Lion Games""/><link type=""boardgamepublisher"" id=""3475"" value=""Arclight Games""/><link type=""boardgamepublisher"" id=""34522"" value=""CrowD Games""/><link type=""boardgamepublisher"" id=""6194"" value=""Delta Vision Publishing""/><link type=""boardgamepublisher"" id=""22380"" value=""Feuerland Spiele""/><link type=""boardgamepublisher"" id=""30213"" value=""Fire on Board Jogos""/><link type=""boardgamepublisher"" id=""15605"" value=""Galápagos Jogos""/><link type=""boardgamepublisher"" id=""45134"" value=""Geekach Games""/><link type=""boardgamepublisher"" id=""4785"" value=""Ghenos Games""/><link type=""boardgamepublisher"" id=""8291"" value=""Korea Boardgames Co., Ltd.""/><link type=""boardgamepublisher"" id=""29242"" value=""Ludofy Creative""/><link type=""boardgamepublisher"" id=""30677"" value=""Maldito Games""/><link type=""boardgamepublisher"" id=""5400"" value=""Matagot""/><link type=""boardgamepublisher"" id=""28323"" value=""Morning""/><link type=""boardgamepublisher"" id=""36186"" value=""PHALANX""/><link type=""boardgamepublisher"" id=""34744"" value=""Playfun Games""/><link type=""boardgamepublisher"" id=""36763"" value=""Surfin' Meeple China""/></item></items>";

        private readonly Uri mockBaseAddress = new Uri("https://whatever");

        private readonly Mock<ILogger<BggService>> _mockLogger;
        private readonly Mock<HttpMessageHandler> _mockMessageHandler;

        private BggService bggService;

        public BggServiceTests()
        {
            _mockLogger = new Mock<ILogger<BggService>>();
            _mockMessageHandler = new Mock<HttpMessageHandler>();

            bggService = new BggService(_mockLogger.Object, new HttpClient(_mockMessageHandler.Object)
            {
                BaseAddress = mockBaseAddress,
            });
        }

        [Fact]
        public async Task Search_EmptyQuery_ReturnsEmptyResponse()
        {
            var searchQuery = string.Empty;

            var searchResponse = await bggService.Search(searchQuery, CancellationToken.None);

            searchResponse.Should().NotBeNull();
            searchResponse.BoardGames.Should().BeEmpty();
        }

        [Fact]
        public async Task Search_HttpFailure_ThrowsException()
        {
            var searchQuery = "Scythe";
            var httpClient = HttpClientHelpers.CreateExceptionThrowingClient(new Exception("Boom!"));
            httpClient.BaseAddress = mockBaseAddress;
            bggService = new BggService(_mockLogger.Object, httpClient);

            var searchFunc = async () => await bggService.Search(searchQuery, CancellationToken.None);

            await searchFunc.Should().ThrowAsync<Exception>();
        }

        // TODO Write tests for the parsing logic (grab BGG response and use as a sample)

        [Fact]
        public async Task GetDetails_InvalidParameter_ArgumentNullException()
        {
            var getDetailsFunc = async () => await bggService.GetDetails(string.Empty, CancellationToken.None);

            await getDetailsFunc.Should().ThrowAsync<ArgumentNullException>();
        }

        [Fact]
        public async Task GetDetails_SuccessfulRequest_ReturnsGameDetails()
        {
            var boardGameId = 169786;
            var httpClient = HttpClientHelpers.CreateClientReturningContent(new StringContent(MockBoardGameDetails));
            httpClient.BaseAddress = mockBaseAddress;
            bggService = new BggService(_mockLogger.Object, httpClient);

            var boardGameDetails = await bggService.GetDetails(boardGameId.ToString(), CancellationToken.None);

            boardGameDetails.Should().NotBeNull();
            boardGameDetails.Id.Should().Be(boardGameId);
        }
    }
}
