variables:
  AppPackageName: com.progrunning.boardgamescompanion
  AppDirectoryName: board_games_companion
  KeyPropertiesFileName: key.properties
  KeyStoreFileName: boardgamescompanion.keystore

trigger:
  batch: 'true'
  branches:
    include:
      - develop
      - release

stages:

- stage: CI
  condition: eq(variables['Build.SourceBranchName'], 'develop')
  jobs:
    - job: Build
      timeoutInMinutes: 12
      pool:
        vmImage: 'macOS-latest'

      steps:
      
        - task: FlutterInstall@0
          displayName: 'Install Flutter'
          inputs:
            channel: 'stable'
            version: 'latest'

        - task: FlutterBuild@0
          displayName: 'Build Android'
          inputs:
            target: 'aab'
            debugMode: true
            projectDirectory: '$(Build.SourcesDirectory)/$(AppDirectoryName)'
            buildNumber: '$(Build.BuildID)'
            buildName: '$(app.version).$(Build.BuildID)'

        - task: FlutterBuild@0
          displayName: 'Build iOS'
          inputs:
            target: 'ios'
            iosCodesign: false
            projectDirectory: '$(Build.SourcesDirectory)/$(AppDirectoryName)'
            buildNumber: '$(Build.BuildID)'
            buildName: '$(app.version).$(Build.BuildID)'


- stage: CD
  condition: eq(variables['Build.SourceBranchName'], 'release')
  jobs:
  - job: ReleaseAndroid
    timeoutInMinutes: 10
    pool:
      vmImage: 'macOS-latest'

    steps:
    
      - task: FlutterInstall@0
        inputs:
          channel: 'stable'
          version: 'latest'

      - task: DownloadSecureFile@1
        displayName: 'Downloading key.properties file'
        inputs:
          secureFile: '$(KeyPropertiesFileName)'

      - task: CopyFiles@2
        displayName: 'Copying key.properties file into the android directory'
        inputs:
          SourceFolder: '$(Agent.TempDirectory)'
          Contents: '$(KeyPropertiesFileName)'
          TargetFolder: '$(Build.SourcesDirectory)/$(AppDirectoryName)/android/'

      - task: DownloadSecureFile@1
        displayName: 'Downloading keystore file'
        inputs:
          secureFile: '$(KeyStoreFileName)'

      - task: CopyFiles@2
        displayName: 'Copying keystore file into the app directory'
        inputs:
          SourceFolder: '$(Agent.TempDirectory)'
          Contents: '$(KeyStoreFileName)'
          TargetFolder: '$(Build.SourcesDirectory)/$(AppDirectoryName)/android/app'


      - task: FlutterBuild@0
        inputs:
          target: 'aab'
          projectDirectory: '$(Build.SourcesDirectory)/$(AppDirectoryName)'
          buildNumber: '$(Build.BuildID)'
          buildName: '$(app.version).$(Build.BuildID)'

      - task: DeleteFiles@1
        displayName: 'Deleting key.properties file'
        condition: always()
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)/android/'
          Contents: '$(KeyPropertiesFileName)'

      - task: DeleteFiles@1
        displayName: 'Deleting keystore file'
        condition: always()
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)/$(AppDirectoryName)/android/app'
          Contents: '$(KeyStoreFileName)'

      - task: DownloadSecureFile@1
        displayName: 'Download Google Play Console JSON key auth file'
        name: serviceAccAuthJson
        inputs:
          secureFile: 'Google_Play_Store_Dev_Ops_Service_Acc_Auth.json'

      - task: Bash@3
        displayName: 'Fastlane - Release aab to Beta'
        inputs:
          workingDirectory: '$(Build.SourcesDirectory)/$(AppDirectoryName)/build/app/outputs/bundle/release'
          targetType: 'inline'
          script: |
          
            fastlane supply --aab app-release.aab --json_key $(serviceAccAuthJson.secureFilePath) --track beta --rollout 1.0 --package_name $(AppPackageName) --skip_upload_apk true

      - task: PublishBuildArtifacts@1
        condition: always()
        displayName: 'Publishing aab artifacts'
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)/$(AppDirectoryName)/build/app/outputs/bundle/release/app-release.aab'
          ArtifactName: 'drop'
          publishLocation: 'Container'

  - job: ReleaseiOS
    timeoutInMinutes: 15
    pool:
      vmImage: 'macOS-latest'

    steps:

      - task: FlutterInstall@0
        inputs:
          channel: 'stable'
          version: 'latest'

      - task: InstallAppleCertificate@2
        inputs:
          certSecureFile: 'Progrunning_Distribution_Cert.p12'
          certPwd: '$(iOSProgrunningDistributionCert)'
          keychain: 'temp'
          deleteCert: true

      - task: InstallAppleProvisioningProfile@1
        inputs:
          provisioningProfileLocation: 'secureFiles'
          provProfileSecureFile: 'Board_Games_Companion_Distribution.mobileprovision'
          removeProfile: true

      - task: FlutterBuild@0
        displayName: 'Build iOS'
        inputs:
          target: 'ios'
          iosCodesign: false
          projectDirectory: '$(Build.SourcesDirectory)/$(AppDirectoryName)'
          buildNumber: '$(Build.BuildID)'
          buildName: '$(app.version).$(Build.BuildID)'

      - task: Xcode@5
        inputs:
          actions: 'build'
          configuration: 'Release'
          sdk: 'iphoneos'
          xcWorkspacePath: '**/ios/Runner.xcworkspace'
          scheme: 'Runner'
          packageApp: true
          signingOption: 'manual'
          signingIdentity: '$(APPLE_CERTIFICATE_SIGNING_IDENTITY)'
          provisioningProfileUuid: '$(APPLE_PROV_PROFILE_UUID)'
          exportPath: '$(Build.SourcesDirectory)/$(AppDirectoryName)/build/app/outputs/ios/'

      - task: AppStoreRelease@1
        inputs:
          serviceEndpoint: 'Apple App Store'
          appIdentifier: '$(AppPackageName)'
          appType: 'iOS'
          ipaPath: '$(Build.SourcesDirectory)/$(AppDirectoryName)/build/app/outputs/ios/*.ipa'
          releaseTrack: 'TestFlight'
          shouldSkipWaitingForProcessing: true
          shouldSkipSubmission: true
          installFastlane: false

      - task: PublishBuildArtifacts@1
        condition: always()
        displayName: 'Publishing aab artifacts'
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)/$(AppDirectoryName)/build/app/outputs/ios/Runner.ipa'
          ArtifactName: 'drop'
          publishLocation: 'Container'